{% extends "admin_base.html" %}

{% block title %}Ingestion Activity · THE13TH Admin{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">

    <!-- Header -->
    <div class="flex items-center justify-between gap-4">
        <div>
            <div class="text-[0.7rem] uppercase tracking-[0.28em] text-purple-200/80 mb-2">
                Lead Intake
            </div>
            <h1 class="text-3xl lg:text-4xl font-semibold text-[#FCE6C8] tracking-tight">
                Ingestion Activity
            </h1>
            <p class="mt-3 text-base text-slate-200 max-w-3xl">
                Live log of webhook and CSV ingestion across brokerages. Use this page to answer
                <span class="italic">“where did that lead go?”</span> in seconds.
            </p>
        </div>
    </div>

    <!-- Filters -->
    <form method="get"
          class="bg-[#120017]/80 border border-purple-600/40 rounded-3xl shadow-lg shadow-purple-900/60 backdrop-blur-xl
                 px-6 py-5 lg:px-8 lg:py-6 flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-[180px]">
            <label class="block text-[0.7rem] font-semibold uppercase tracking-[0.22em] text-purple-200/80 mb-1.5">
                Tenant key
            </label>
            <input
                type="text"
                name="tenant_key"
                value="{{ tenant_key }}"
                placeholder="e.g. demo-brokerage"
                class="w-full rounded-2xl bg-black/30 border border-purple-500/50 px-3.5 py-2.5 text-xs sm:text-sm text-slate-100
                       focus:outline-none focus:ring-2 focus:ring-fuchsia-500/80 focus:border-transparent placeholder:text-slate-500"
            />
        </div>
        <div class="flex-1 min-w-[160px]">
            <label class="block text-[0.7rem] font-semibold uppercase tracking-[0.22em] text-purple-200/80 mb-1.5">
                Source
            </label>
            <input
                type="text"
                name="source"
                value="{{ source }}"
                placeholder="facebook, zillow_csv"
                class="w-full rounded-2xl bg-black/30 border border-purple-500/50 px-3.5 py-2.5 text-xs sm:text-sm text-slate-100
                       focus:outline-none focus:ring-2 focus:ring-fuchsia-500/80 focus:border-transparent placeholder:text-slate-500"
            />
        </div>
        <div class="w-40">
            <label class="block text-[0.7rem] font-semibold uppercase tracking-[0.22em] text-purple-200/80 mb-1.5">
                Channel
            </label>
            <select
                name="channel"
                class="w-full rounded-2xl bg-black/30 border border-purple-500/50 px-3.5 py-2.5 text-xs sm:text-sm text-slate-100
                       focus:outline-none focus:ring-2 focus:ring-fuchsia-500/80 focus:border-transparent"
            >
                <option value="" {% if not channel %}selected{% endif %}>All</option>
                <option value="webhook" {% if channel == 'webhook' %}selected{% endif %}>Webhook</option>
                <option value="csv" {% if channel == 'csv' %}selected{% endif %}>CSV</option>
            </select>
        </div>
        <div class="w-40">
            <label class="block text-[0.7rem] font-semibold uppercase tracking-[0.22em] text-purple-200/80 mb-1.5">
                Status
            </label>
            <select
                name="status"
                class="w-full rounded-2xl bg-black/30 border border-purple-500/50 px-3.5 py-2.5 text-xs sm:text-sm text-slate-100
                       focus:outline-none focus:ring-2 focus:ring-fuchsia-500/80 focus:border-transparent"
            >
                <option value="" {% if not status %}selected{% endif %}>All</option>
                <option value="success" {% if status == 'success' %}selected{% endif %}>Success</option>
                <option value="skipped" {% if status == 'skipped' %}selected{% endif %}>Skipped</option>
                <option value="error" {% if status == 'error' %}selected{% endif %}>Error</option>
            </select>
        </div>
        <div class="w-28">
            <label class="block text-[0.7rem] font-semibold uppercase tracking-[0.22em] text-purple-200/80 mb-1.5">
                Limit
            </label>
            <input
                type="number"
                name="limit"
                min="1"
                max="500"
                value="{{ limit }}"
                class="w-full rounded-2xl bg-black/30 border border-purple-500/50 px-3.5 py-2.5 text-xs text-slate-100
                       focus:outline-none focus:ring-2 focus:ring-fuchsia-500/80 focus:border-transparent"
            />
        </div>
        <div class="flex gap-2 pt-2">
            <button
                type="submit"
                class="inline-flex items-center justify-center rounded-full px-4 py-2.5 text-xs sm:text-sm font-medium
                       bg-gradient-to-r from-purple-500 via-fuchsia-500 to-pink-500 text-white
                       shadow-lg shadow-purple-900/60 hover:brightness-110 transition"
            >
                Apply filters
            </button>
            <a
                href="/admin/ingestion/logs"
                class="inline-flex items-center justify-center rounded-full px-4 py-2.5 text-xs sm:text-sm font-medium
                       bg-white/5 text-slate-100 border border-purple-500/50 hover:bg-white/10 transition"
            >
                Reset
            </a>
        </div>
    </form>

    <!-- Table -->
    <div class="bg-[#120017]/80 border border-purple-600/40 rounded-3xl shadow-lg shadow-purple-900/60 backdrop-blur-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-purple-600/50 flex items-center justify-between">
            <div class="text-xs sm:text-sm text-slate-200">
                Showing <span class="font-semibold text-slate-50">{{ events|length }}</span> events
                {% if tenant_key %}
                    for <span class="font-mono text-[11px] text-purple-200">{{ tenant_key }}</span>
                {% endif %}
                {% if source %}
                    (source: <span class="font-mono text-[11px] text-purple-200">{{ source }}</span>)
                {% endif %}.
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full text-xs sm:text-sm">
                <thead class="bg-black/40 text-slate-200">
                    <tr>
                        <th class="px-4 py-2 text-left font-medium">Time</th>
                        <th class="px-4 py-2 text-left font-medium">Tenant</th>
                        <th class="px-4 py-2 text-left font-medium">Source</th>
                        <th class="px-4 py-2 text-left font-medium">Channel</th>
                        <th class="px-4 py-2 text-left font-medium">Status</th>
                        <th class="px-4 py-2 text-left font-medium">Lead</th>
                        <th class="px-4 py-2 text-left font-medium">Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% if events %}
                        {% for event in events %}
                            <tr class="border-t border-purple-800/60 hover:bg-white/5">
                                <td class="px-4 py-2 whitespace-nowrap text-[11px] text-slate-200">
                                    {{ event.created_at }}
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap font-mono text-[11px] text-slate-100">
                                    {{ event.tenant_key or "—" }}
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap font-mono text-[11px] text-slate-100">
                                    {{ event.source }}
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap font-mono text-[11px] text-slate-100">
                                    {{ event.channel }}
                                </td>
                                <td class="px-4 py-2">
                                    {% if event.status == 'success' %}
                                        <span class="inline-flex items-center rounded-full bg-emerald-500/10 border border-emerald-500/60
                                                     px-2.5 py-0.5 text-[0.65rem] uppercase tracking-[0.18em] text-emerald-200">
                                            Success
                                        </span>
                                    {% elif event.status == 'skipped' %}
                                        <span class="inline-flex items-center rounded-full bg-amber-500/10 border border-amber-500/60
                                                     px-2.5 py-0.5 text-[0.65rem] uppercase tracking-[0.18em] text-amber-200">
                                            Skipped
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center rounded-full bg-red-500/10 border border-red-500/60
                                                     px-2.5 py-0.5 text-[0.65rem] uppercase tracking-[0.18em] text-red-200">
                                            Error
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-2">
                                    {% if event.lead_id %}
                                        <a href="/admin/leads/{{ event.lead_id }}"
                                           class="inline-flex items-center gap-1 text-[11px] text-purple-200 hover:text-purple-100 underline decoration-fuchsia-400/70">
                                            #{{ event.lead_id }}
                                        </a>
                                    {% else %}
                                        <span class="text-[11px] text-slate-400">—</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-2 text-[11px] text-slate-100">
                                    {{ event.message }}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="px-4 py-6 text-center text-xs text-slate-400">
                                No ingestion events found for the current filters.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
