from __future__ import annotations

import logging
from typing import Any

from fastapi import APIRouter, Depends, HTTPException, Request
from fastapi.responses import HTMLResponse
from sqlalchemy.orm import Session

from backend_v2.database import get_db
from backend_v2.services.auth_service import authenticated_admin
from backend_v2.services.render import render_template
from backend_v2.services.report_viewer_service import (
    list_reports,
    get_report_detail,
)

logger = logging.getLogger("the13th.admin_reports.router")

router = APIRouter(prefix="/admin/reports", tags=["Admin Reports"])


@router.get("/", response_class=HTMLResponse)
def admin_reports_index(
    request: Request,
    admin: Any = Depends(authenticated_admin),
    db: Session = Depends(get_db),
) -> HTMLResponse:
    """
    Admin view: list of simulation reports from SimReportLog.
    """
    reports = list_reports(db)
    context = {
        "request": request,
        "admin": admin,
        "reports": reports,
    }
    return render_template("admin_report_list.html", context)


@router.get("/{report_id}", response_class=HTMLResponse)
def admin_report_detail(
    report_id: int,
    request: Request,
    admin: Any = Depends(authenticated_admin),
    db: Session = Depends(get_db),
) -> HTMLResponse:
    """
    Admin view: single report detail.
    """
    report = get_report_detail(db, report_id=report_id)
    if report is None:
        raise HTTPException(status_code=404, detail="Report not found")

    context = {
        "request": request,
        "admin": admin,
        "report": report,
    }
    return render_template("admin_report_detail.html", context)
