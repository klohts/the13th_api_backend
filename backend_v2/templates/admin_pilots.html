<!-- the13th/templates/admin_pilots.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>THE13TH — Admin · Pilot Command Center</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        :root {
            --bg-start: #4b0082;
            --bg-end: #0a0014;

            --glass-bg: rgba(255,255,255,0.06);
            --glass-border: rgba(255,255,255,0.12);

            --accent-warm: #f6d6a8;
            --accent-purple: #7c3aed;
            --accent-fuchsia: #d946ef;

            --text-main: #f9f5ff;
            --text-soft: rgba(240,230,255,0.75);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background: radial-gradient(circle at top left, var(--bg-start), var(--bg-end));
            color: var(--text-main);
        }

        .page-shell {
            max-width: 1380px;
            margin: 0 auto;
            padding: 44px 28px 70px;
        }

        .badge {
            display: inline-flex;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 11px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: linear-gradient(120deg, rgba(124,58,237,0.35), rgba(217,70,239,0.35));
            border: 1px solid rgba(255,255,255,0.14);
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 34px;
            margin: 12px 0 6px;
            font-weight: 600;
            color: var(--accent-warm);
            letter-spacing: 0.02em;
        }

        h2 {
            font-size: 15px;
            font-weight: 500;
            margin: 0 0 26px;
            color: var(--text-soft);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 24px;
            margin-bottom: 26px;
        }

        .legend {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 12px;
            letter-spacing: 0.06em;
        }

        .pill {
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            backdrop-filter: blur(8px);
        }

        .pill-requested {
            background: rgba(126,234,160,0.15);
            color: #9dffd1;
            border: 1px solid rgba(126,234,160,0.25);
        }

        .pill-approval {
            background: rgba(255,214,102,0.18);
            color: #ffe29b;
            border: 1px solid rgba(255,214,102,0.25);
        }

        .pill-active {
            background: rgba(80,200,255,0.18);
            color: #a5eaff;
            border: 1px solid rgba(80,200,255,0.25);
        }

        .card {
            margin-top: 10px;
            border-radius: 22px;
            background: linear-gradient(160deg, rgba(255,255,255,0.09), rgba(10,0,20,0.9));
            border: 1px solid var(--glass-border);
            box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: linear-gradient(
                90deg,
                rgba(30,10,60,0.95),
                rgba(60,20,120,0.95)
            );
        }

        th, td {
            padding: 16px 18px;
        }

        th {
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(214,190,255,0.85);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        tbody tr:nth-child(even) {
            background: rgba(255,255,255,0.015);
        }

        tbody tr:hover {
            background: radial-gradient(circle at top left, rgba(124,58,237,0.22), rgba(1,0,16,0.96));
        }

        .subline {
            font-size: 12px;
            color: rgba(226,211,255,0.7);
        }

        .status-pill {
            display: inline-flex;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            backdrop-filter: blur(10px);
        }

        .status-requested {
            background: rgba(126,234,160,0.2);
            color: #9dffd1;
        }

        .status-approval_sent {
            background: rgba(255,214,102,0.24);
            color: #ffe29b;
        }

        .status-active {
            background: rgba(80,200,255,0.24);
            color: #a5eaff;
        }

        .approve-btn {
            border: none;
            border-radius: 999px;
            padding: 10px 18px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-fuchsia));
            color: #fff;
            box-shadow: 0 14px 34px rgba(0,0,0,0.6);
            transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s;
        }

        .approve-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        .approve-btn:disabled {
            opacity: 0.5;
            cursor: default;
            box-shadow: none;
        }

        .empty-row td {
            text-align: center;
            padding: 34px 16px;
            color: rgba(230,213,255,0.65);
            font-size: 14px;
        }

        /* KPI STRIP */
        .metrics-card {
            margin-top: 8px;
            margin-bottom: 14px;
            border-radius: 20px;
            background: radial-gradient(circle at top left, rgba(124,58,237,0.3), rgba(10,0,20,0.96));
            border: 1px solid rgba(255,255,255,0.14);
            box-shadow: 0 26px 50px rgba(0,0,0,0.6);
            backdrop-filter: blur(18px);
            padding: 16px 20px 14px;
        }

        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-soft);
        }

        .metrics-header-left span {
            font-weight: 500;
            color: var(--accent-warm);
        }

        .metrics-header-right {
            font-size: 11px;
            opacity: 0.85;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 14px;
        }

        .metric {
            padding: 10px 14px 12px;
            border-radius: 16px;
            background: rgba(6,3,20,0.86);
            border: 1px solid rgba(255,255,255,0.16);
        }

        .metric-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(235,222,255,0.8);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .metric-sub {
            font-size: 11px;
            color: rgba(230,213,255,0.7);
            margin-top: 2px;
        }

        .metric-value.accent-gold {
            color: #ffdba8;
        }

        .metric-value.accent-aqua {
            color: #9de3ff;
        }

        .metric-value.accent-lime {
            color: #b2ffc9;
        }

        .metric-value.accent-purple {
            color: #c4a5ff;
        }

        /* TOAST NOTIFICATION */
        .toast {
            position: fixed;
            right: 26px;
            bottom: 26px;
            max-width: 360px;
            padding: 12px 16px;
            border-radius: 18px;
            background: radial-gradient(circle at top left, rgba(124,58,237,0.9), rgba(15,6,35,0.95));
            border: 1px solid rgba(255,255,255,0.2);
            color: #fffaf3;
            font-size: 13px;
            box-shadow: 0 18px 55px rgba(0,0,0,0.85);
            opacity: 0;
            transform: translateY(18px);
            pointer-events: none;
            transition: opacity 0.18s ease-out, transform 0.18s ease-out;
            z-index: 40;
        }

        .toast-show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .toast-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .toast-body {
            font-size: 12px;
            opacity: 0.92;
        }

        .toast-pill {
            display: inline-flex;
            margin-top: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            background: rgba(10,10,30,0.9);
            border: 1px solid rgba(255,255,255,0.25);
        }

        @media (max-width: 900px) {
            .metric-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 640px) {
            .metric-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 26px;
            }
        }
    </style>
</head>

<body>
<div class="page-shell">

    <div class="header-row">
        <div>
            <div class="badge">Admin · Pilot Command Center</div>
            <h1>Revenue Intelligence Pilot Requests</h1>
            <h2>Review incoming brokerages, qualify instantly, and trigger live Stripe checkout in one click.</h2>

            <div class="legend">
                <span>LEGEND:</span>
                <span class="pill pill-requested">Requested</span>
                <span class="pill pill-approval">Approval Sent</span>
                <span class="pill pill-active">Active</span>
            </div>
        </div>
    </div>

    <!-- KPI STRIP -->
    <div class="metrics-card">
        <div class="metrics-header">
            <div class="metrics-header-left">
                <span>Pilot Funnel ·</span>
                <span id="metric-total-label"> Live view</span>
            </div>
            <div class="metrics-header-right">
                Auto-refresh every 60s when this tab is active.
            </div>
        </div>
        <div class="metric-grid">
            <div class="metric">
                <div class="metric-label">Total Pilots</div>
                <div class="metric-value accent-gold" id="metric-total">0</div>
                <div class="metric-sub">Across all statuses</div>
            </div>
            <div class="metric">
                <div class="metric-label">Requested</div>
                <div class="metric-value accent-lime" id="metric-requested">0</div>
                <div class="metric-sub">Awaiting approval</div>
            </div>
            <div class="metric">
                <div class="metric-label">Checkout Sent</div>
                <div class="metric-value accent-purple" id="metric-approval-sent">0</div>
                <div class="metric-sub">Stripe link emailed</div>
            </div>
            <div class="metric">
                <div class="metric-label">Active · Est. MRR</div>
                <div class="metric-value accent-aqua" id="metric-active-mrr">$0</div>
                <div class="metric-sub" id="metric-active-count">0 active pilots</div>
            </div>
        </div>
    </div>

    <div class="card">
        <table id="pilot-table">
            <thead>
            <tr>
                <th>Brokerage</th>
                <th>Contact</th>
                <th>Role</th>
                <th>Agents</th>
                <th>Status</th>
                <th>Problem / Notes</th>
                <th>Requested</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            {% if pilots %}
                {% for pilot in pilots %}
                {% set status_value = pilot.status.name if pilot.status and pilot.status.name is defined else pilot.status %}
                <tr data-pilot-id="{{ pilot.id }}">
                    <td>{{ pilot.brokerage_name or "—" }}</td>
                    <td>
                        <div>{{ pilot.contact_name or "—" }}</div>
                        <div class="subline">{{ pilot.contact_email or pilot.email or "" }}</div>
                    </td>
                    <td>{{ pilot.role or "—" }}</td>
                    <td>{{ pilot.agents or pilot.agents_count or "—" }}</td>
                    <td>
                        <span class="status-pill
                            {% if status_value == 'REQUESTED' %}status-requested{% endif %}
                            {% if status_value == 'APPROVAL_SENT' %}status-approval_sent{% endif %}
                            {% if status_value == 'ACTIVE' %}status-active{% endif %}">
                            {{ status_value.replace('_',' ') if status_value else '' }}
                        </span>
                    </td>
                    <td>{{ pilot.problem_notes or "—" }}</td>
                    <td>
                        {% if pilot.requested_at %}
                            {{ pilot.requested_at.strftime("%b %d, %Y • %I:%M %p") }}
                        {% else %}—{% endif %}
                    </td>
                    <td>
                        <button class="approve-btn" {% if status_value != 'REQUESTED' %}disabled{% endif %}>
                            {% if status_value == 'APPROVAL_SENT' %}Checkout Sent
                            {% elif status_value == 'ACTIVE' %}Active
                            {% else %}Approve &amp; Send Checkout{% endif %}
                        </button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr class="empty-row">
                    <td colspan="8">No pilot requests yet.</td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Toast notification container -->
<div class="toast" id="toast">
    <div class="toast-title" id="toast-title"></div>
    <div class="toast-body" id="toast-body"></div>
    <div class="toast-pill">ADMIN UPDATE</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const table = document.querySelector("#pilot-table");
    const toastEl = document.getElementById("toast");
    const toastTitle = document.getElementById("toast-title");
    const toastBody = document.getElementById("toast-body");

    const METRIC_ANCHOR_MRR = 699; // anchor per active pilot

    function showToast(title, body) {
        if (!toastEl) return;
        toastTitle.textContent = title || "";
        toastBody.textContent = body || "";
        toastEl.classList.add("toast-show");
        setTimeout(() => {
            toastEl.classList.remove("toast-show");
        }, 4000);
    }

    function recalculateMetrics() {
        const rows = document.querySelectorAll("#pilot-table tbody tr[data-pilot-id]");
        let total = 0;
        let requested = 0;
        let approvalSent = 0;
        let active = 0;

        rows.forEach((row) => {
            const pill = row.querySelector(".status-pill");
            if (!pill) return;
            total += 1;

            if (pill.classList.contains("status-requested")) {
                requested += 1;
            } else if (pill.classList.contains("status-approval_sent")) {
                approvalSent += 1;
            } else if (pill.classList.contains("status-active")) {
                active += 1;
            }
        });

        const totalEl = document.getElementById("metric-total");
        const requestedEl = document.getElementById("metric-requested");
        const approvalEl = document.getElementById("metric-approval-sent");
        const activeMrrEl = document.getElementById("metric-active-mrr");
        const activeCountEl = document.getElementById("metric-active-count");

        if (totalEl) totalEl.textContent = total.toString();
        if (requestedEl) requestedEl.textContent = requested.toString();
        if (approvalEl) approvalEl.textContent = approvalSent.toString();

        const estMrr = active * METRIC_ANCHOR_MRR;
        if (activeMrrEl) {
            activeMrrEl.textContent = estMrr
                ? "$" + estMrr.toLocaleString("en-US")
                : "$0";
        }
        if (activeCountEl) {
            activeCountEl.textContent = active === 1
                ? "1 active pilot"
                : active.toString() + " active pilots";
        }
    }

    // Initial KPI calc
    recalculateMetrics();

    if (table) {
        table.addEventListener("click", async (event) => {
            const btn = event.target.closest(".approve-btn");
            if (!btn || btn.disabled) return;

            const row = btn.closest("tr");
            const pilotId = row?.dataset?.pilotId;
            if (!pilotId) return;

            const originalLabel = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Sending…";

            try {
                const response = await fetch(`/admin/pilots/${pilotId}/approve`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const statusRaw = data.status || "";
                const status = statusRaw.toUpperCase();

                const pill = row.querySelector(".status-pill");
                if (pill) {
                    pill.classList.remove(
                        "status-requested",
                        "status-approval_sent",
                        "status-active"
                    );

                    if (status === "APPROVAL_SENT") {
                        pill.classList.add("status-approval_sent");
                        pill.textContent = "APPROVAL SENT";
                        showToast(
                            "Checkout email sent",
                            "Stripe pilot checkout link has been emailed to this brokerage."
                        );
                    } else if (status === "ACTIVE") {
                        pill.classList.add("status-active");
                        pill.textContent = "ACTIVE";
                        showToast(
                            "Pilot activated",
                            "Stripe confirmed payment and this pilot is now active."
                        );
                    } else if (status === "REQUESTED") {
                        pill.classList.add("status-requested");
                        pill.textContent = "REQUESTED";
                    }
                }

                btn.textContent = "Checkout Sent";

                // Recompute KPIs after status change
                recalculateMetrics();
            } catch (err) {
                console.error(err);
                btn.disabled = false;
                btn.textContent = originalLabel;
                alert("There was a problem sending the checkout link. Please try again.");
            }
        });
    }

    // Soft auto-refresh: reload every 60s when tab is visible
    const REFRESH_MS = 60000;
    setInterval(() => {
        if (!document.hidden) {
            window.location.reload();
        }
    }, REFRESH_MS);
});
</script>
</body>
</html>
